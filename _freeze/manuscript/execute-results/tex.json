{
  "hash": "3a91012f7d7b5e81f03b68579924df69",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: Harnessing AI to annotate the severity of all phenotypic abnormalities within the Human Phenotype Ontology\nauthor:\n  - name: Kitty B Murphy\n    orcid: \n    corresponding: true\n    email: kitty.murphy@ukdri.ac.uk\n    roles:\n      - Investigation\n      - Project administration\n      - Software\n      - Visualization\n    affiliations:\n      - Department of Brain Sciences, Imperial College London, UK \n      - UK Dementia Research Institute at Imperial College London, UK\n  - name: Brian M Schilder\n    orcid: \n    corresponding: true\n    roles: \n      - Investigation\n      - Project administration\n      - Software\n      - Visualization\n    affiliations:\n      - Department of Brain Sciences, Imperial College London, UK \n      - UK Dementia Research Institute at Imperial College London, UK\n  - name: Nathan G Skene\n    orcid: \n    corresponding: true\n    roles: \n      - Investigation\n      - Project administration\n      - Software\n      - Visualization\n    affiliations:\n      - Department of Brain Sciences, Imperial College London, UK \n      - UK Dementia Research Institute at Imperial College London, UK\nkeywords:\n  - HPO\n  - chatGPT\n  - rare disease \nbibliography: references.bib\n---\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nlibrary(dplyr)\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\n\nAttaching package: 'dplyr'\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nThe following objects are masked from 'package:stats':\n\n    filter, lag\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nThe following objects are masked from 'package:base':\n\n    intersect, setdiff, setequal, union\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\nlibrary(ggplot2)\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nWarning: package 'ggplot2' was built under R version 4.3.2\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\nlibrary(patchwork)\nlibrary(HPOExplorer)\n```\n:::\n\n\n## Abstract\n\nThe Human phenotype Ontology (HPO) has played a crucial role in defining, diagnosing, prognosing, and treating human diseases by providing a standardised database for phenotypic abnormalities. However, there is currently no information pertaining to the severity of each phenotype, making systematic analyses and prioritisation of results difficult. With 18,082 abnormalities now corresponding to over 10,000 rare diseases, manual curation of such phenotypic annotations by experts would be labor-intensive and time-consuming. Leveraging advances in artificial intelligence, we employed the OpenAI GPT-4 model with Python to systematically annotate the severity of ~ 17,000 phenotypic abnormalities in the HPO. By checking that phenotypes with guaranteed outcomes were appropriately annotated, we demonstrate the potential for natural language processing technologies to automate the curation process accurately. For example, phenotypes such as \"decreased male fertility\" were used to compute a true positive rate, as they would be expected to be annotated as often, if not always, causing reduced fertility. Across the annotated outcomes, we observed > 73 % annotation accuracy. Using a novel approach, we developed a severity scoring system that incorporates both the nature of the phenotype outcome and the frequency of its occurrence. These severity metrics will enable efforts to systematically prioritise which human phenotypes are most detrimental to human well being, and best targets for therapeutic intervention. \n\n## Introduction\n\nComprehensive annotation of phenotypic abnormalities is invaluable for defining, diagnosing, prognosing, and treating human disease. Since 2008, the Human phenotype Ontology (HPO) has been instrumental to this, by providing a standardised database for the description and analysis of human phenotypes @Gargano2024-nj. Through developing open community resources, the depth and breadth of the HPO has continued to expand and there are now ~ 18,000 phenotypic abnormalities, corresponding to > 10,000 rare diseases, described. In recent years, the HPO has expanded its disease annotations so that each HPO term can have metadata including typical age of onset and frequency. In addition, there are the Clinical modifier (put this in italics) and Clinical course (also italics) subontologies, which contains terms to describe factors including severity and triggers, and mortality and progression, respectively. Describing the severity-related attributes of a disease is crucial for attaining significant objectives in rare diseases. This includes enhancing diagnostic capabilities, as well as prioritising and guiding gene therapy trials.\n\nTo date, the HPO has largely been manually curated by experts including clinicians, clinical geneticists, and researchers. Although this approach ensures the quality and accuracy of the ontology, it is time-consuming and labour-intensive. As a result, less than 1% of terms within the HPO have metadata pertaining to their features such as time course and severity. As artificial intelligence (AI) capabilities advance, there is an opportunity to integrate natural language processing technologies into assisting in the curation process. Here, we have used the OpenAI GPT-4 model (https://openai.com/) with Python to systematically annotate the severity of > 17,000 phenotypic abnormalities within the HPO. Our severity annotation framework was developed based on previously defined criteria developed through consultation with clinicians 2. The authors consulted 192 healthcare professionals for their opinions on the relative severity of various clinical characteristics: they used this to create a system for categorising the severity of  diseases. Briefly, each healthcare professional was sent a survey asking them to first rate how important a disease characteristic was for determining disease severity, and then to rate the severity of a set of given disease. Using the responses, the authors were able to categorise clinical characteristics into 4 ‘severity tiers’. While characteristics such as shortened lifespan in infancy and intellectual disability were identified as highly severe and placed into tier 1, sensory impairment and reduced lifespan were categorised as less severe and placed into tier 4. Being able to quickly ascribe severity measures based on those criteria to HPO phenotypes, will assist with interpreting phenome-wide studies. \n\nAlmost 800 phenotypes were annotated twice to evaluate annotation consistency, and a true positive rate of annotations was calculated to assess annotation accuracy. Additionally, based on the clinical characteristics and their occurrence, we have quantified the severity of each phenotype, providing an example of how these clinical characteristic annotations can be used to guide prioritisation of gene therapy trials. Ultimately, we hope that our resource will be of utility to those working in rare diseases, as well as the wider rare disease community.\n\n## Results \n\n### Annotating the HPO using OpenAI GPT-4\nWe employed the OpenAI GPT-4 model with Python to annotate 16,982 terms within the Human phenotype Ontology (HPO). Our annotation framework was developed based on previously defined criteria for classifying disease severity @Lazarin2014-rz. We sought to evaluate the impact of phenotypes on outcomes including intellectual disability, death, impaired mobility, physical malformations, blindness, sensory impairments, immunodeficiency, cancer, reduced fertility, and congenital onset. Through prompt design we found that the performance of GPT-4 improved when we incorporated a scale associated with each effect and required a justification for each response. For each effect, we asked about the likelihood of its occurrence - whether it never, rarely, often, or always occurred. Furthermore, our prompt design revealed that the optimal trade-off between the number of phenotypes and performance was achieved when inputting no more than two or three phenotypes per prompt. An example prompt can be seen in Figure 1. The phenotype outcome occurrence varied by category. While > 50% of annotated phenotypes never caused blindness, cancer, immunodeficiency, intellectual disability, reduced fertility, and sensory impairment, a similar proportion often or always had congenital onset (Fig. 1).\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\n# read in hpo gpt annotations \nhpo_annot <- HPOExplorer::gpt_annot_read()\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nTranslating ontology terms to ids.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nReading cached RDS file: phenotype_to_genes.txt\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\n+ Version: \n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\n208 phenotypes do not have matching HPO IDs.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nReading in GPT annotations for 16,925 phenotypes.\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\n# subset to clinical characteristics \noccurr_df <- hpo_annot[,c(\"hpo_name\", \"intellectual_disability\", \"death\", \"impaired_mobility\", \"blindness\",\n                          \"sensory_impairments\", \"immunodeficiency\", \"cancer\", \"reduced_fertility\",\n                          \"congenital_onset\")]\n\ncols_of_interest <- names(occurr_df)[-1]\n\n# Create an empty dataframe to store the counts\ncount_df <- data.frame(matrix(0, nrow = length(cols_of_interest), ncol = 4))\ncolnames(count_df) <- c(\"always\", \"often\", \"rarely\", \"never\")\nrownames(count_df) <- cols_of_interest\n\n# Loop through each column of interest and count the occurrences of 'always', 'often', 'rarely', 'never'\nfor (col in cols_of_interest) {\n  counts <- table(occurr_df[[col]])\n  count_df[col, ] <- counts[match(colnames(count_df), names(counts))]\n}\n\ncount_df_long <- tidyr::gather(count_df, key = \"condition\", value = \"count\", always:never)\ncount_df_long$category <- rownames(count_df)\n\ncount_df_long$category <- gsub(\"_\", \" \", count_df_long$category)\ncount_df_long$condition <- factor(count_df_long$condition, levels=c(\"always\", \"often\", \"rarely\", \"never\"))\n\ncount_df_long <- count_df_long %>%\n  dplyr::group_by(category) %>%\n  dplyr::mutate(percentage = count / sum(count) * 100)\n\n# set annotation order for plots \nannotation_order <- c(\"death\", \"intellectual disability\", \"impaired mobility\", \"blindness\", \n                      \"congenital onset\", \"physical malformations\", \"sensory impairments\", \n                      \"immunodeficiency\", \"cancer\", \"reduced fertility\")\n\ncount_df_long$category <- factor(count_df_long$category, levels = annotation_order)\n\n# Stacked bar plot of clinical characteristic occurrence\nggplot(count_df_long, aes(x = category, y = count, fill = condition)) +\n  geom_bar(stat = \"identity\") +\n  labs(title = \"Clinical characteristic occurrence\",\n       x = \"\", y = \"HPO phenotypes (n)\", fill = NULL) +\n  theme_minimal() +\n  theme(legend.position = \"right\", plot.title = element_text(hjust=0.5), \n        text = element_text(size=16),\n        axis.text.x = element_text(angle=45, size=16, hjust=1), \n        title = element_text(size=15)) +\n  scale_fill_brewer(palette = \"GnBu\", direction = -1)\n```\n\n::: {.cell-output-display}\n![](manuscript_files/figure-pdf/occurence_plot-1.pdf){fig-pos='H'}\n:::\n:::\n\n\n![Figure 1: GPT-4 was able to annotate all human phenotypes based on whether they are always/often/rarely/never associated with different clinical characteristics. a An example of the prompt input given to to GPT-4. The phenotypes listed in the last sentence were changed to allow ~17,000 phenotypes to be annotated. b Stacked bar plot showing the proportion of the occurrence of each clinical characteristic across all ~17,000 phenotypes annotated.The terms shown on the X-axis are the clinical characteristics, for which GPT-4 was asked to determine whether each phenotype caused them. For example, it annotated ‘Respiratory arrest’ as always causing death. Only 75 phenotypes were annotated as always causing death, despite 9,544 phenotypes often or rarely causing it.](figures/clinical_characteristic_occurrence.png)\n### Annotation consistency and accuracy\nTo assess annotation consistency, 793 phenotypes underwent duplicate annotations, with two metrics employed to determine the 'consistency rate'. The first, less stringent metric, defined consistency as the duplicate annotations being either 'always' and 'often', or 'never' and 'rarely'. The second, more stringent metric, required exact agreement in annotation occurrences, e.g. 'always' and 'always'. For the less stringent metric, duplicated phenotypes were annotated consistently at a rate of at least 80%, and for the more stringent metric, the lowest consistency rate was 57%, for congenital onset. An example of where annotations were inconsistent was for the HPO term ‘Acute leukaemia’. One time, GPT-4 annotated it as often causing impaired mobility, giving the justification that ‘weakness and fatigue from leukaemia and its treatment can impair mobility’. The other time, GPT-4 annotated it as rarely causing impaired mobility, giving the justification that ‘acute leukaemia rarely impairs mobility directly’. Despite specifying in the prompt for GPT-4 not to take into consideration indirect effects, here is an example of where it failed to do so. \n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\n# Annotation checks\nchecks <- HPOExplorer::gpt_annot_check()\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nTranslating ontology terms to ids.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nReading cached RDS file: phenotype_to_genes.txt\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\n+ Version: \n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\n208 phenotypes do not have matching HPO IDs.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nReading in GPT annotations for 16,925 phenotypes.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nNumber of phenotype hits per query group:\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\n - intellectual_disability: 6\n - impaired_mobility: 293\n - physical_malformations: 78\n - blindness: 1\n - sensory_impairments: 252\n - immunodeficiency: 5\n - cancer: 697\n - reduced_fertility: 5\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nWarning: The `facets` argument of `facet_grid()` is deprecated as of ggplot2 2.2.0.\ni Please use the `rows` argument instead.\ni The deprecated feature was likely used in the HPOExplorer package.\n  Please report the issue at\n  <https://github.com/neurogenomics/HPOExplorer/issues>.\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\n# Define items to be checked\nitems <- c(\"consistency_count\", \"consistency_rate\",\n           \"consistency_stringent_count\", \"consistency_stringent_rate\",\n           \"true_pos_count\", \"true_pos_rate\")\n\nmetric_types <- c(\"Rate\", \"Count\")[1]\n\n# Get data frame with checks values\ncheck_df <- lapply(checks[items], data.table::as.data.table, keep.rownames = TRUE) |>\n  data.table::rbindlist(idcol = \"metric\") |>\n  data.table::setnames(c(\"metric\", \"annotation\", \"value\"))\n\ncheck_df$metric <- factor(check_df$metric,\n                          levels = items,\n                          ordered = TRUE)\n\ncheck_df$annotation <- factor(check_df$annotation,\n                              levels = unique(check_df$annotation),\n                              ordered = TRUE)\n\ncheck_df[, metric_type := ifelse(grepl(\"count\", metric),\n                                 \"Count\", ifelse(grepl(\"rate\", metric), \"Rate\", NA))]\n\ncheck_df[, metric_category := gsub(\"_count|_rate\", \"\", metric)]\n\ncheck_df$metric_type <- factor(check_df$metric_type, ordered = TRUE)\n\ncheck_df <- check_df[annotation != \"pheno_count\"]\n\ncheck_df[, n := value[metric_type == \"Count\"],\n         by = c(\"metric_category\", \"annotation\")]\n\ncheck_df$annotation <- gsub(\"_\", \" \", check_df$annotation)\nannotation_order <- unique(check_df$annotation)\ncheck_df$annotation <- factor(check_df$annotation, levels = annotation_order)\ncheck_df$metric_category <- gsub(\"_\", \" \", check_df$metric_category)\n\nmetric_categories <- c(\"consistency\", \"consistency stringent\")\n```\n:::\n\n::: {#cell-fig-checks .cell}\n\n```{.r .cell-code .hidden}\nconsistency_plot <- ggplot(check_df[metric_type %in% metric_types & metric_category %in% metric_categories, ],\n                           aes(x = annotation, y = value,\n                               fill = metric_category,\n                               label = round(value, 2))) +\n  geom_bar(stat = \"identity\", show.legend = TRUE) +\n  facet_grid(facets = ~metric_category, scales = \"free\") +\n  theme_bw() +\n  labs(x = \"\", y = \"Value\") +\n  ggtitle(\"Annotation consistency\") +\n  scale_fill_manual(values = c(\"#C3DAEAFF\", \"#ECE28BFF\")) +\n  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 16),\n        legend.position = \"none\",\n        text = element_text(size = 16),\n        title = element_text(size = 15),\n        plot.title = element_text(hjust = 0.5)) +\n  geom_text(aes(x = 7.5, y = 1.05, label = \"N phenotypes = 793\"), size = 4)\n\n\nmetric_categories <- \"true pos\"\n\naccuracy_plot <- ggplot(check_df[metric_type %in% metric_types & metric_category %in% metric_categories, ],\n                        aes(x = annotation, y = value,\n                            fill = metric_category,\n                            label = n)) +\n  geom_bar(stat = \"identity\", show.legend = TRUE) +\n  theme_bw() +\n  labs(x = \"\", y = \"Value\") +\n  ggtitle(\"True positive rate\") +\n  scale_fill_manual(values = c(\"#B1D5BBFF\")) +\n  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 16),\n        legend.position = \"none\",\n        text = element_text(size = 16),\n        title = element_text(size = 15),\n        plot.title = element_text(hjust = 0.5)) +\n  geom_label(fill = \"white\", size = 4)\n\nconsistency_plot + accuracy_plot + plot_layout(widths = c(1, 0.7)) +\n  plot_annotation(tag_levels = 'a') & theme(plot.tag = element_text(size = 18, face = \"bold\"))\n```\n\n::: {.cell-output-display}\n![GPT-4 annotations are consistent and accurate across annotations. a Barplot showing the annotation consistency for 793 phenotypes that were annotated twice. On the left hand side, annotations were defined as consistent if the given phenotype was annotated to the same outcome occurrence both times, or if it was annotated to ‘always’ and ‘often’, or, ‘never’ and ‘rarely. On the right hand side, annotations were only defined as consistent if the given phenotype was annotated to the same outcome occurrence both times. b Bar plot of the true positive rate for each annotation. The true positives were determined based on the assumption that all descendants of some HPO phenotypes should be related to those outcomes. For instance, all descendents of the HPO term for “Neoplasm” were considered to be true positives for cancer (an assumption which is not always the case, as GPT-4 detects, as some neoplasms are benign). The labels above each bar indicate the number of phenotypes tested.](manuscript_files/figure-pdf/fig-checks-1.pdf){#fig-checks fig-pos='H'}\n:::\n:::\n\n\nIn order to evaluate the accuracy of the annotations, we calculated a true positive rate. This involved identifying specific branches within the HPO that would contain phenotypes that would reliably indicate the presence of certain conditions. For instance, the phenotypes 'decreased fertility in females' and 'decreased fertility in males' should, in the annotations, often, if not always, cause reduced fertility. We observed an encouraging true positive rate exceeding 70% across all phenotype outcomes. The lowest rate was observed for cancer (73%), for which all descendants of the HPO term ‘Neoplasm’ were considered to be true positives. However, this assumption, as GPT-4 detects, is not always true as these abnormal tissue/cell growths can be either cancerous or benign. For example, the HPO term ‘multiple digital exostoses’, which are benign bone tumours, is a descendant of the HPO term ‘Neoplasm’, and GPT-4 annotated it as rarely causing cancer, giving the justification that ‘Bone growths may rarely become cancerous’. This high level of accuracy underscores the robustness of our annotations and the reliability of the HPO framework in capturing clinically relevant phenotypic information. However, we acknowledge that the number of testable phenotypes for some of these categories are low. Furthermore, some of the ‘true positive’ phenotypes are synonymous to the clinical characteristic itself, for instance, for testing the true positive rate of the characteristic ‘Intellectual disability’, the phenotype ‘Severe intellectual disability’ was used. \n\n### Quantifying phenotypic severity\nQuantifying the severity of phenotypes can have important implications for diagnosis, prognosis, and treatment, for instance, guiding prioritisation of gene therapy trials for the most severe phenotypes. First, we created a dictionary to map each phenotype outcome (e.g. blindness) and its response (always, often, rarely, never) to numeric values from 0-4. Then, the phenotype outcome values were multiplied by their associated response values. Importantly, the values reflected the severity of each outcome based on both the outcome itself and the frequency of the response. For instance, a phenotype always causing death would have a higher multiplied value than a phenotype rarely causing reduced fertility. Next, we computed an average score for each phenotype by aggregating the multiplied values across all phenotype outcomes and then calculating the mean. This was then normalised by the theoretical maximum severity score, so that all phenotypes were on a 0-100 severity scale (where 100 is the most severe phenotype possible). This average normalised score represents the overall severity of the phenotype based on the severity of its individual outcomes.\n\nBased on these scores we evaluated the top 50 severe phenotypes. The most severe phenotype, with a score of 58, was ‘Anencephaly’ (HP:0002323). Anencephaly is a birth defect where the baby is born without a portion of its brain and skull, often these babies are stillborn. In fact, many of the most severe phenotypes were related to developmental brain and neural tube defects. Comparison of the severity scores for each response, across the phenotype outcomes annotated, revealed consistent trends: as the response of the phenotype outcome increased (from never to always), the severity score also increased (Supplementary Fig. 1). We also evaluated the severity score distribution by HPO branch and calculated the mean severity score using all phenotypes within a HPO branch (Fig. 4). After the term ‘Phenotypic abnormality’, the highest severity score was for the HPO branch ‘Abnormal cellular phenotype’, followed by ‘Abnormality of prenatal development or birth’, which would include the high severity scoring phenotypes seen in Fig. 3. \n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\n# get all descendants of the term phenotypic abnormality \nkeep_descendants=\"Phenotypic abnormality\"\nkeep_ont_levels=seq(3,17)\n\nancestor_name <- variable <- hpo_id <- hpo_name <-\n  value <- severity_score_gpt <- mean_severity_score_gpt <- NULL;\n\n#### Prepare annotation results ####\ngpt_annot <- HPOExplorer::gpt_annot_read()\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nTranslating ontology terms to ids.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nReading cached RDS file: phenotype_to_genes.txt\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\n+ Version: \n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\n208 phenotypes do not have matching HPO IDs.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nReading in GPT annotations for 16,925 phenotypes.\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\nres_coded <- HPOExplorer::gpt_annot_codify(annot = gpt_annot)\ndat1 <- HPOExplorer:::gpt_annot_melt(res_coded = res_coded)\n\n#### Filter out ont levels ####\ndat1 <- add_ancestor(dat1,\n                     keep_descendants = keep_descendants)\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nAdding level-2 ancestor to each HPO ID.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nAdding ancestor metadata.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nAncestor metadata already present. Use force_new=TRUE to overwrite.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nTranslating ontology terms to ids.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nKeeping descendants of 1 term(s).\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\n17,719 terms remain after filtering.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\n172,670 associations remain after filtering.\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\ndata.table::setorderv(dat1,\"severity_score_gpt\",-1)\n\ndat1 <- HPOExplorer::add_ont_lvl(dat1, keep_ont_levels = keep_ont_levels)\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nGetting absolute ontology level for 18,281 IDs.\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\ndat1$variable <- gsub(\"_\", \" \", dat1$variable)\n\n# get all unique phenotypes\ntotal_unique <- length(unique(dat1$hpo_id))\n\n# get the top N phenotypes\ntop_n=15\ndat_top <- dat1[hpo_id %in% unique(dat1$hpo_id)[seq(top_n)]]\n\n# Get the bottom N phenotypes\nbottom_n <- 15\ndat_bottom <- dat1[hpo_id %in% unique(dat1$hpo_id)[seq(total_unique - bottom_n + 1, total_unique)]]\n\n# Define the range for selecting phenotypes from the middle\nstart_index <- ceiling(total_unique / 2)  \nend_index <- start_index + 12\n\n# Get phenotypes from the middle\ndat_middle <- dat1[hpo_id %in% unique(dat1$hpo_id)[seq(start_index, end_index)]]\n\n# define labels\ndat_top$position <- \"Top\"\ndat_middle$position <- \"Middle\"\ndat_bottom$position <- \"Bottom\"\n\ndat_all <- rbind(dat_top, dat_middle, dat_bottom)\ndat_all$position <- factor(dat_all$position, levels=c(\"Top\", \"Middle\", \"Bottom\"))\n\ndat_all$variable <- factor(dat_all$variable, levels = annotation_order)\n```\n:::\n\n::: {#cell-fig-severity .cell}\n\n```{.r .cell-code .hidden}\np1 <- ggplot2::ggplot(data = dat_all,\n                      ggplot2::aes(x=variable, y=hpo_name, fill=value)) +\n  ggplot2::geom_tile(colour = \"white\", lwd = 0.5, linetype =1) +\n  ggplot2::scale_y_discrete(limits=rev) +\n  scale_fill_brewer(palette = \"GnBu\", direction = -1) +\n  ggplot2::theme_classic() +\n  ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 45, hjust = 1),\n                 legend.position = 'right',\n                 text = element_text(size=16)) +\n  labs(x = \"Clinical characteristic\",\n       y = \"HPO term\",\n       fill = \"\") +\n  ggplot2::facet_grid(position ~ ., scales = \"free_y\")\n\np2 <- ggplot2::ggplot(data = dat_all,\n                      ggplot2::aes(x=\"severity_score_gpt\", y=hpo_name,\n                                   fill=severity_score_gpt)) +\n  ggplot2::geom_tile() +\n  ggplot2::scale_y_discrete(limits=rev) +\n  scale_fill_gradientn(colours = colorspace::heat_hcl(7), trans = \"reverse\") +\n  ggplot2::labs(x=NULL, y=NULL, fill = \"Severity score\") +\n  ggplot2::theme_void() +\n  ggplot2::theme(axis.text.y = ggplot2::element_blank(),\n                 axis.ticks.y = ggplot2::element_blank(),\n                 legend.position = 'right') +\n  guides(fill = guide_colorbar(reverse = TRUE))\n\np3 <- patchwork::wrap_plots(p1, p2, ncol = 2,\n                            widths = c(1,.2),\n                            guides = \"collect\")\n\nprint(p3)\n```\n\n::: {.cell-output-display}\n![Quantifying the severity of HPO phenotype annotations highlights the most impactful conditions. Heatmap of the top (n = 15), mid-range (n = 15), and bottom (n = 15) HPO phenotypes based on severity score. Severity scores were calculated by multiplying the numeric values assigned to each clinical characteristic (death = 5, intellectual disability = 5, impaired mobility = 4, blindness = 4, congenital onset = 4, physical malformations = 3, sensory impairments = 3, immunodeficiency = 3,  cancer = 3, reduced fertility = 1) by their corresponding response frequencies (Always = 4, Often = 3, Rarely = 2, Never = 0). The average normalised score, representing overall phenotype severity on a 0-100 scale, was calculated by aggregating the multiplied values and normalising by the theoretical maximum severity score. The x-axis is scaled by the severity of the clinical characterisation.](manuscript_files/figure-pdf/fig-severity-1.pdf){#fig-severity fig-pos='H'}\n:::\n:::\n\n\n## Discussion\n\nHere, we present a novel approach leveraging the OpenAI GPT-4 model, to systematically annotate the severity of 17,000 phenotypic abnormalities within the HPO. Our findings highlight the potential of natural language processing technologies in significantly contributing to the automation and refinement of the curation process in genomics and rare disease research.\nManual curation of ontologies has traditionally relied on expert input, a process that is both time-consuming and labor-intensive. By employing advanced AI capabilities, we have demonstrated the feasibility of automating this process, significantly enhancing efficiency without compromising accuracy. Our validation approach yielded a high true positive rate exceeding 73% across the phenotypes tested. Furthermore, our approach can be readily adapted and scaled to accommodate the growing volume of phenotypic data.\n\nA key contribution of our study is the development of a severity scoring system that integrates both the nature of the phenotype outcome and the frequency of its occurrence. By quantifying the phenotypic severity this way, we highlight the most impactful conditions and provide a comprehensive framework for prioritising gene therapy trials and guiding clinical decision-making in rare diseases.\n\n** Brian to pick examples from severity scoring ** \n\nGiven its scalability it can be easily applied as more phenotypes are added to the HPO, but can also be extended to include different annotations and to be used with other ontologies. For instance, we could have also tried to use GPT-4 to annotate how prevalent a phenotype is in the human population, or what the cost to the health system is of a phenotype. Currently there are no systematic annotations of these on a phenotypic level. However, it’s unclear whether GPT-4 could currently be applied for such annotations, or whether they require much more extensive data collection. \n\nImportantly, there are additional factors that need to be considered when trying to prioritise phenotypes for their suitability for gene therapy development. First, our scoring is in some sense subjective, for instance, one could ask is something that always causes death, always worse than something which causes a lifetime of other severe clinical characteristics. In terms of viability for a clinical trial, a phenotype which causes a lifetime of expensive burden on the medical system may be a better target than a phenotype which causes a quick death with little or no other clinical characteristics before. It would be worth exploring whether GPT-4 could estimate such costs. Another factor that affects the viability of developing a treatment for a therapy is how quickly a clinical trial can be run. For instance, measuring a high risk of respiratory failure over ten years would require a long trial. However, testing for total reversal of an existing severe phenotype would be much faster. As AI capabilities continue to advance, perhaps this is something GPT-4 and other models of the like could test for. \n\nAn additional annotation that we didn’t take into consideration here is that GPT-4 might be aware of whether there are existing treatments for these phenotypes. Therefore, some of the top-ranking severe phenotype we have identified may already have treatment options available. It would therefore be useful to know whether a phenotype, although highly severe, is currently treatable, and also whether there exist known clinical endpoints for clinical trial testing. GPT-4 does seem to take into account quality of care, i.e. the degree to which health services increase the likelihood of desired outcomes (World Health Organization). For example, many of the cancer phenotypes are justified as always or often causing death unless treated or caught early. On the other hand, some cancers are justified as rarely causing death if appropriate treatment is provided, which may not always be the case for individuals or populations with access to less advanced medical systems. In future efforts, we might want to ask GPT-4 more explicitly to distinguish between whether a phenotype would cause death without treatment, or with best available standard of care. \n\nWhile our study demonstrates the feasibility and utility of AI-driven phenotypic annotation, several limitations must be acknowledged. The reliance on computational algorithms may introduce biases or inaccuracies inherent to the training data, necessitating ongoing validation and refinement of our approach. Additionally, our severity scoring system, while comprehensive, may not capture the full spectrum of phenotypic variability or account for complex gene-environment interactions. Future research should focus on further optimising AI-driven annotation methodologies, incorporating additional data modalities such as genomic and clinical data to enhance accuracy.\n\nIn conclusion, our study represents a significant step towards harnessing the power of AI to advance phenotypic annotation and severity assessment in rare diseases. This resource aims to provide researchers and clinicians with actionable insights that can inform rare disease research and improve the lives of individuals affected by rare diseases.\n\n## Methods \n\n### Annotating the HPO using OpenAI GPT-4\nWe employed the OpenAI GPT-4 model with Python to annotate 16,982 terms within the Human phenotype Ontology (HPO). Our annotation framework was developed based on previously defined criteria for classifying disease severity (Lazarin et al., 2014). We sought to evaluate the impact of phenotypes on factors including intellectual disability, death, impaired mobility, physical malformations, blindness, sensory impairments, immunodeficiency, cancer, reduced fertility, and congenital onset. Through prompt design we found that the performance of GPT-4 improved when we incorporated a scale associated with each effect and required a justification for each response. For each effect, we asked about the likelihood of its occurrence - whether it never, rarely, often, or always occurred.\n\n### Calculating the true positive rate\nA true positive rate was calculated as a measure of the accuracy of the GPT-4 annotations. This was achieved by identifying specific branches within the HPO that would contain phenotypes that would reliably indicate the occurrence of certain clinical characteristics, and using all descendants of this HPO branch as true positives. For example, all descendants of the terms Abnormal central motor function and abnormality of movement should always or often cause impaired mobility (Table 1). \n\n| Clinical characteristics | True positive HPO branch |\n| ------------------------ | ------------------------ |\n| Intellectual disability  | Intellectual disability (HP:0001249)\n| Impaired mobility.       | Abnormal central motor function (HP:0011442) and Abnormality of movement (HP:0100022)\n| Physical malformations   | Malformation (string search)\n| Blindness                | Blindness (HP:0000618)\n| Sensory impairments      | Abnormality of vision (HP:0000504), Abnormality of the sense of smell (HP:0004408), Abnormality of taste sensation (HP:0000223), Somatic sensory dysfunction (HP:0003474), and Hearing abnormality (HP:0000364)\n| Immunodeficiency         | Immunodeficiency (HP:0002721)\n| Cancer                   | Neoplasm (HP:0002664)\n| Reduced fertility        | Decreased fertility (HP:0000144)\n\n### Quantifying phenotypic severity\nThe GPT-4 generated annotation occurrences were converted into a semi-quantitative scoring system, with ‘always’ corresponding to 3, ‘often’ to 2, ‘rarely’ to 1, and ‘never’ to 0. These scores were then weighted by a severity metric on a scale of 1-5, with 5 representing the highest severity, as determined by the provided annotations (Table 2). Subsequently, the weighted scores underwent normalisation to yield a final quantitative severity score ranging from 0-100, with 100 signifying the maximum severity score attainable.\n\n| Clinical characteristic     | Always (4) | Often (3) | Rarely (2) | Never (0) |\n| Intellectual_disability (5) |     20     |     15    |    10      |     0     | \n| Impaired_mobility (5)       |     20     |     15    |    10      |     0     | \n| Blindness (4)               |     16     |     12    |    8       |     0     | \n| Congenital onset (4)        |     16     |     12    |    8       |     0     | \n| Physical_malformations (3)  |     12     |     9     |    6       |     0     | \n| Sensory_impairments (3)     |     12     |     9     |    6       |     0     | \n| Immunodeficiency (3)        |     12     |     9     |    6       |     0     | \n| Cancer (3)                  |     12     |     9     |    6       |     0     | \n| Reduced_fertility (1)       |     4      |     3     |    2       |     0     | \n\n\n## Supplementary figures\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\ndat2 <- HPOExplorer:::gpt_annot_melt(res_coded = res_coded)\ndat2 <- add_ancestor(dat2,\n                     keep_descendants = keep_descendants)\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nAdding level-2 ancestor to each HPO ID.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nAdding ancestor metadata.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nAncestor metadata already present. Use force_new=TRUE to overwrite.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nTranslating ontology terms to ids.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nKeeping descendants of 1 term(s).\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\n17,719 terms remain after filtering.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\n172,670 associations remain after filtering.\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\ndat2[,mean_severity_score_gpt:=mean(severity_score_gpt, na.rm=TRUE),\n     by=\"ancestor_name\"] |>\n  data.table::setorderv(\"mean_severity_score_gpt\", -1, na.last = TRUE)\ndat2[,ancestor_name:=factor(ancestor_name,\n                            levels = unique(dat2$ancestor_name),\n                            ordered = TRUE)]\n\nggplot2::ggplot(dat2, ggplot2::aes(x=severity_score_gpt\n                                   # fill=factor(congenital_onset)\n)) +\n  ggplot2::geom_histogram(bins = 50, fill=\"slateblue\") +\n  ggplot2::geom_vline(ggplot2::aes(xintercept=mean_severity_score_gpt),\n                      color=\"red\") +\n  ggplot2::geom_label(data = unique(\n    dat2[,list(mean_severity_score_gpt), by=\"ancestor_name\"]\n  ),\n  ggplot2::aes(x=mean_severity_score_gpt,\n               y=Inf,\n               label=round(mean_severity_score_gpt,2)),\n  color=\"red\", size=3, hjust = 0, vjust = 1.5, alpha=.65) +\n  ggplot2::facet_wrap(facets = \"ancestor_name~.\", scales = \"free_y\",\n                      ncol = 3) +\n  ggplot2::labs(y=\"Frequency\", x=\"Severity score\") +\n  ggplot2::theme_bw() +\n  ggplot2::theme(strip.background = ggplot2::element_rect(\n    fill = \"transparent\"), \n    text = element_text(size=16))\n```\n\n::: {.cell-output-display}\n![](manuscript_files/figure-pdf/supp_figure_1-1.pdf){fig-pos='H'}\n:::\n:::\n\n\n## References {.unnumbered}\n\n:::{#refs}\n\n:::",
    "supporting": [
      "manuscript_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": null,
    "postProcess": false
  }
}